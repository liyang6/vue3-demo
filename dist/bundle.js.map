{"version":3,"file":"bundle.js","sources":["../src/shared/index.ts","../src/reactivity/effect.ts","../src/reactivity/baseHandlers.ts","../src/reactivity/reactive.ts"],"sourcesContent":["export const isObject = (val:unknown):val is Object => typeof val == 'object' && val !== null;\r\n\r\nconst hasOwnProperty = Object.prototype.hasOwnProperty;\r\nexport const hasOwn = (target, key) => hasOwnProperty.call(target,key);\r\n\r\nexport const isArray = (target) => Array.isArray(target);\r\n\r\nexport const hasChange = (oldVal, newVal) => oldVal !== newVal;","import { isArray } from \"../shared\";\r\n\r\nexport const effect = (fn) => { \r\n  const effect = createReactiveEffect(fn);\r\n  effect();\r\n}\r\n\r\nexport let effectStack = []\r\nexport let activeEffect = null\r\nlet id = 0;\r\nfunction createReactiveEffect(fn) { \r\n  const effect = function () { \r\n    /* ？？？？？？？？ */\r\n    if (!effectStack.includes(effect)) { \r\n      try {\r\n        effectStack.push(effect);\r\n        activeEffect = effect;\r\n        return fn();\r\n      } finally { \r\n        effectStack.pop();\r\n        activeEffect = effectStack[effectStack.length-1]\r\n      }\r\n    }\r\n   \r\n    \r\n    \r\n  }\r\n  effect.id = id++;\r\n\r\n  return effect;\r\n}\r\n\r\nconst targetMap = new WeakMap;\r\n/* { \r\n  对象：{name:[]}\r\n} */\r\nexport function track(target, key) {\r\n  if (activeEffect == null) {\r\n    return;\r\n  }\r\n\r\n  let depsMap = targetMap.get(target);\r\n  if (!depsMap) {\r\n    targetMap.set(target, depsMap = new Map());\r\n  }\r\n  let dep = depsMap.get(key)\r\n  if (!dep) {\r\n    depsMap.set(key, dep = new Set())\r\n  }\r\n\r\n  if (!dep.has(activeEffect)) {\r\n    dep.add(activeEffect)\r\n  }\r\n\r\n  \r\n  console.log('targetMap',targetMap);\r\n\r\n}\r\n\r\n// 修改\r\nexport function trigger(target,type,key,value) { \r\n  const depsMap = targetMap.get(target);\r\n  if (!depsMap) { // 没有依赖直接跳过 \r\n    return;\r\n  }\r\n\r\n  if (!key) {  //没有标识\r\n    return;\r\n  }\r\n\r\n  /* ？？？？？？？？ */\r\n  if (key === 'length' && isArray(target)) {\r\n    depsMap.forEach((dep, key) => {\r\n      console.log('----', dep, key, value);\r\n      \r\n      if (key === 'length' || key > value) {\r\n        run(dep)\r\n      }\r\n\r\n    })\r\n  } else { \r\n    let effects = depsMap.get(key); // 收集过\r\n    run(effects);\r\n\r\n    // 依赖，添加，数组，修改下标的时候push\r\n    switch (type) { \r\n      case 'add':\r\n        if (isArray(target)) { \r\n          if (parseInt(key) == key) {\r\n            debugger\r\n            run(depsMap.get('length')) /* ？？？？？？？？ */\r\n          }\r\n        }\r\n    }\r\n  }\r\n\r\n  \r\n  \r\n}\r\n\r\nfunction run(effects) { \r\n  if(effects) effects.forEach(effect => effect());\r\n}\r\n\r\n\r\n  \r\n\r\n\r\n\r\n\r\n","import { effectStack,track, trigger } from \"./effect\";\r\nimport { isObject, isArray, hasOwn, hasChange } from \"../shared\";\r\nimport { reactive } from \"./reactive\";\r\n\r\nexport const mutableHandlers = {\r\n  get(target, key, recevier) {  // 内置的 proxy中get和set参数是固定的\r\n\r\n    console.log('get',target, key, recevier)\r\n    let res = Reflect.get(target, key, recevier);\r\n\r\n    if (typeof key === 'symbol') { \r\n      return res;\r\n    }\r\n\r\n    track(target, key); //属性和effect关联\r\n\r\n    return isObject(res) ? reactive(res) : res; // taget[key]\r\n  }, // 当取值的时候 应该将effect 存储起来\r\n  set(target, key, value, recevier) {\r\n    let oldVal = target[key]\r\n    let result = Reflect.set(target, key, value, recevier);\r\n\r\n    let hadKey = isArray(target) && parseInt(key) == key ? Number(key) < target.length : hasOwn(target, key);\r\n    // 新增、修改操作\r\n    if (!hadKey) {\r\n      trigger(target, 'add', key, value)\r\n    } else if(hasChange(oldVal,value)){ \r\n      trigger(target,'set',key,value)\r\n    }\r\n      // effectStack.forEach(effect=>effect());\r\n      return result\r\n  } // 当设置值的时候 应该通知对\r\n}","import { isObject } from \"../shared\"\nimport { mutableHandlers } from \"./baseHandlers\";\n\nexport const reactive = (target) => {\n    return createReactiveObject(target,mutableHandlers)\n}\n\nconst reactiveMap = new WeakMap();\n/* \nWeakMap\n  {\n  target:\n    {} ：new proxy(target)\n  }\n*/\nfunction createReactiveObject(target,baseHandler) { \n  if (!isObject(target)) { \n    return target\n  }\n\n  let existProxy = reactiveMap.get(target);\n  if (existProxy) { \n    return existProxy\n  }\n\n  const proxy = new Proxy(target, baseHandler);\n  reactiveMap.set(target, proxy);\n  return proxy;\n}\n"],"names":[],"mappings":"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"}